# 日志系统实现细节

## 1. 系统概述

WW日志系统是一个灵活、高效的嵌入式日志解决方案，主要特点：
- 支持两种日志模式：字符串模式(STRING)和编码模式(ENCODE)
- 模块化管理，可单独启用/禁用模块
- 编译时和运行时多级过滤
- 自动文件ID生成系统
- 极小的代码占用(尤其编码模式)

## 2. 日志模式

### 2.1 字符串模式(STRING)

**特点**：
- 人类可读的输出格式
- 支持标准printf格式化
- 输出示例：`[INF] app_main.c:42 - Application started`

**实现**：
- 核心函数：`ww_log_str_output()`
- 自动从`__FILE__`提取短文件名
- 支持运行时模块和级别过滤

### 2.2 编码模式(ENCODE)

**特点**：
- 二进制编码，最小化代码占用
- 格式：32位头 + 参数(可选)
- 头部分解：
  - LOG_ID(12b) | LINE(12b) | DATA_LEN(6b) | LEVEL(2b)
- 需要外部工具解码

**实现**：
- 核心函数：`ww_log_encode_output()`
- 可选RAM缓冲区存储日志
- 支持运行时模块和级别过滤

## 3. 模块化管理

### 3.1 模块配置
- 每个模块有唯一ID(0-31)
- 可在`log_config.json`中配置启用/禁用
- 模块掩码：`g_ww_log_module_mask`(运行时控制)

### 3.2 静态模块开关
- 编译时可完全移除禁用模块的日志代码
- 通过Makefile的`STATIC_OPTS`控制

## 4. 文件ID系统

### 4.1 自动生成
- `tools/gen_file_ids.py`根据`log_config.json`生成：
  - Makefile变量(文件ID、模块ID)
  - C头文件`auto_file_ids.h`

### 4.2 文件ID分配
- 每个模块有基础ID(`base_id`)
- 每个文件有偏移量(`offset`)
- 最终文件ID = `base_id` + `offset`

## 5. 多级过滤

### 5.1 编译时过滤
- `WW_LOG_COMPILE_THRESHOLD`：编译时级别阈值
- 低于阈值的日志代码不会被编译

### 5.2 运行时过滤
- `g_ww_log_level_threshold`：运行时级别阈值
- `g_ww_log_module_mask`：模块启用掩码

## 6. 配置系统

### 6.1 编译配置
- 模式选择(在`ww_log.h`中)：
  - `WW_LOG_MODE_STR`
  - `WW_LOG_MODE_ENCODE`
  - `WW_LOG_MODE_DISABLED`

### 6.2 运行时配置
- `log_config.json`定义：
  - 模块配置(ID、基础ID、启用状态)
  - 文件到模块的映射

## 7. 构建系统

### 7.1 文件ID注入
- Makefile自动为每个文件注入：
  - `CURRENT_FILE_ID`
  - `CURRENT_MODULE_ID`
  - `CURRENT_MODULE_STATIC_EN`

### 7.2 编译选项
- `STATIC_OPTS`：静态模块开关
- `WW_LOG_ENCODE_RAM_BUFFER_EN`：启用RAM缓冲区(编码模式)
